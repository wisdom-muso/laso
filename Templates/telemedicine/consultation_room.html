{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% translate "Video Consultation Room" %}{% endblock %}

{% block extra_css %}
<style>
    .consultation-room {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }

    .consultation-header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .jitsi-container {
        background: #000;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        height: 600px;
        position: relative;
    }

    .jitsi-meet-frame {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 15px;
    }

    .consultation-info {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .participant-info {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    .participant-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #007bff;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-online { background-color: #28a745; }
    .status-offline { background-color: #dc3545; }

    .consultation-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    .btn-consultation {
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }

    .btn-end-call {
        background: linear-gradient(45deg, #dc3545, #c82333);
        border: none;
        color: white;
    }

    .btn-end-call:hover {
        background: linear-gradient(45deg, #c82333, #a71e2a);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="consultation-room">
    <div class="container-fluid">
        <!-- Consultation Header -->
        <div class="consultation-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-1">
                        <i class="fas fa-video me-2 text-primary"></i>
                        {% translate "Video Consultation" %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if consultation.appointment %}
                            {{ consultation.appointment.appointment_type }} - {{ consultation.appointment.scheduled_date|date:"M d, Y \a\t H:i" }}
                        {% else %}
                            {% translate "Telemedicine Session" %}
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex align-items-center justify-content-end gap-3">
                        <span class="status-indicator status-online"></span>
                        <span class="fw-bold text-success">{% translate "Connected" %}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jitsi Meet Video Container -->
        <div class="row">
            <div class="col-lg-9">
                <div class="jitsi-container">
                    <iframe 
                        id="jitsi-frame"
                        class="jitsi-meet-frame"
                        src="https://meet.jit.si/{{ consultation.room_name }}?config.startWithAudioMuted=false&config.startWithVideoMuted=false&config.prejoinPageEnabled=false&config.disableDeepLinking=true&userInfo.displayName={{ user.get_full_name|urlencode }}"
                        allow="camera; microphone; fullscreen; display-capture">
                    </iframe>
                </div>

                <!-- Consultation Controls -->
                <div class="consultation-controls">
                    <button type="button" class="btn btn-consultation btn-end-call" onclick="endConsultation()">
                        <i class="fas fa-phone-slash me-2"></i>
                        {% translate "End Consultation" %}
                    </button>
                    <a href="{% url 'telemedicine:session_list' %}" class="btn btn-consultation btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        {% translate "Back to Sessions" %}
                    </a>
                </div>
            </div>

            <!-- Consultation Info Sidebar -->
            <div class="col-lg-3">
                <div class="consultation-info">
                    <h5 class="mb-3">
                        <i class="fas fa-users me-2"></i>
                        {% translate "Participants" %}
                    </h5>

                    <!-- Doctor Info -->
                    {% if consultation.doctor %}
                    <div class="participant-info">
                        <div class="participant-avatar">
                            {{ consultation.doctor.first_name.0 }}{{ consultation.doctor.last_name.0 }}
                        </div>
                        <div>
                            <div class="fw-bold">Dr. {{ consultation.doctor.get_full_name }}</div>
                            <small class="text-muted">
                                <span class="status-indicator status-online"></span>
                                {% translate "Doctor" %}
                            </small>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Patient Info -->
                    {% if consultation.patient %}
                    <div class="participant-info">
                        <div class="participant-avatar">
                            {{ consultation.patient.first_name.0 }}{{ consultation.patient.last_name.0 }}
                        </div>
                        <div>
                            <div class="fw-bold">{{ consultation.patient.get_full_name }}</div>
                            <small class="text-muted">
                                <span class="status-indicator status-online"></span>
                                {% translate "Patient" %}
                            </small>
                        </div>
                    </div>
                    {% endif %}

                    <hr>

                    <!-- Session Details -->
                    <h6 class="mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        {% translate "Session Details" %}
                    </h6>
                    
                    <div class="mb-2">
                        <small class="text-muted">{% translate "Session ID" %}:</small><br>
                        <code>{{ consultation.id }}</code>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">{% translate "Started" %}:</small><br>
                        <span>{{ consultation.created_at|date:"M d, Y H:i" }}</span>
                    </div>

                    {% if consultation.appointment %}
                    <div class="mb-2">
                        <small class="text-muted">{% translate "Appointment" %}:</small><br>
                        <span>{{ consultation.appointment.appointment_type }}</span>
                    </div>
                    {% endif %}

                    <hr>

                    <!-- Quick Actions -->
                    <h6 class="mb-3">
                        <i class="fas fa-tools me-2"></i>
                        {% translate "Quick Actions" %}
                    </h6>

                    <div class="d-grid gap-2">
                        {% if user.is_doctor %}
                        <a href="{% url 'treatments:vitals:realtime_patient_dashboard' consultation.patient.id %}" 
                           class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-heartbeat me-2"></i>
                            {% translate "View Patient Vitals" %}
                        </a>
                        {% endif %}
                        
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="copyRoomLink()">
                            <i class="fas fa-link me-2"></i>
                            {% translate "Copy Room Link" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function endConsultation() {
    if (confirm('{% translate "Are you sure you want to end this consultation?" %}')) {
        // Update consultation status
        fetch('{% url "telemedicine:end" consultation.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'action': 'end'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "telemedicine:session_list" %}';
            } else {
                alert('{% translate "Error ending consultation. Please try again." %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% translate "Error ending consultation. Please try again." %}');
        });
    }
}

function copyRoomLink() {
    const roomLink = window.location.href;
    navigator.clipboard.writeText(roomLink).then(function() {
        alert('{% translate "Room link copied to clipboard!" %}');
    }, function(err) {
        console.error('Could not copy text: ', err);
        alert('{% translate "Could not copy link. Please copy manually from address bar." %}');
    });
}

// Auto-resize iframe on window resize
window.addEventListener('resize', function() {
    const frame = document.getElementById('jitsi-frame');
    if (frame) {
        frame.style.height = '600px';
    }
});
</script>
{% endblock %}