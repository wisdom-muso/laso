{% extends "base.html" %}

{% block title %}Note Details - {{ note.patient.get_full_name }}{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
        <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
            <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                    SOAP Note Detail
                </h1>
                <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                    <li class="breadcrumb-item text-muted"><a href="{% url 'core:soap-note-list' note.patient.id %}"
                            class="text-muted text-hover-primary">History</a></li>
                    <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                    <li class="breadcrumb-item text-dark">{{ note.encounter_date|date:"M d, Y" }}</li>
                </ul>
            </div>
            <div class="d-flex align-items-center gap-2 gap-lg-3">
                {% if note.status == 'draft' and user == note.provider %}
                <form method="post" action=""
                    onsubmit="return confirm('Are you sure you want to sign this note? It will become read-only.')">
                    {% csrf_token %}
                    <button type="submit" name="sign" class="btn btn-sm btn-success">
                        <i class="fas fa-signature me-2"></i> Sign & Lock
                    </button>
                </form>
                {% endif %}
                <button onclick="window.print()" class="btn btn-sm btn-secondary">
                    <i class="fas fa-print me-2"></i> Print
                </button>
            </div>
        </div>
    </div>

    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-xxl">

            <div class="card">
                <div class="card-header">
                    <div class="card-title m-0">
                        <div class="d-flex flex-column">
                            <h3 class="fw-bold m-0">{{ note.patient.get_full_name }} <span
                                    class="text-muted fs-6 fw-normal">({{ note.patient.gender }}/{{
                                    note.patient.date_of_birth|date:"Y-m-d" }})</span></h3>
                            <div class="text-muted fs-7 fw-bold mt-1">
                                Encounter: {{ note.get_encounter_type_display }} â€¢ {{ note.encounter_date|date:"F d, Y
                                H:i" }}
                            </div>
                        </div>
                    </div>
                    <div class="card-toolbar">
                        {% if note.status == 'signed' %}
                        <span class="badge badge-success fs-7">Signed by {{ note.provider.get_full_name }}</span>
                        {% else %}
                        <span class="badge badge-warning fs-7">Draft</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body p-9">

                    <!-- Subjective -->
                    <div class="mb-10">
                        <h4 class="text-dark fw-bold mb-3 border-bottom pb-2">Subjective</h4>
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Chief Complaint:</div>
                            <div class="col-md-9">{{ note.chief_complaint }}</div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">HPI:</div>
                            <div class="col-md-9">{{ note.history_of_present_illness|linebreaks }}</div>
                        </div>
                        {% if note.review_of_systems %}
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Review of Systems:</div>
                            <div class="col-md-9">{{ note.review_of_systems }}</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Objective -->
                    <div class="mb-10">
                        <h4 class="text-dark fw-bold mb-3 border-bottom pb-2">Objective</h4>
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Vitals:</div>
                            <div class="col-md-9">{{ note.vital_signs_summary|default:"Not recorded" }}</div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Physical Exam:</div>
                            <div class="col-md-9">{{ note.physical_examination|linebreaks }}</div>
                        </div>
                    </div>

                    <!-- Assessment -->
                    <div class="mb-10">
                        <h4 class="text-dark fw-bold mb-3 border-bottom pb-2">Assessment</h4>
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Primary Diagnosis:</div>
                            <div class="col-md-9">{{ note.primary_diagnosis }}</div>
                        </div>
                        {% if note.differential_diagnoses %}
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Differential:</div>
                            <div class="col-md-9">{{ note.differential_diagnoses }}</div>
                        </div>
                        {% endif %}
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Impression:</div>
                            <div class="col-md-9">{{ note.clinical_impression|linebreaks }}</div>
                        </div>
                    </div>

                    <!-- Plan -->
                    <div class="mb-10">
                        <h4 class="text-dark fw-bold mb-3 border-bottom pb-2">Plan</h4>
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Treatment Plan:</div>
                            <div class="col-md-9">{{ note.treatment_plan|linebreaks }}</div>
                        </div>
                        {% if note.medications_prescribed %}
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Rx:</div>
                            <div class="col-md-9">{{ note.medications_prescribed }}</div>
                        </div>
                        {% endif %}
                        {% if note.follow_up_instructions %}
                        <div class="row mb-4">
                            <div class="col-md-3 text-gray-600 fw-bold">Follow-up:</div>
                            <div class="col-md-9">{{ note.follow_up_instructions }}</div>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}